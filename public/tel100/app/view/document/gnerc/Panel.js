/*
 * File: app/view/document/file/Panel.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Tel100.view.document.gnerc.Panel', {
  extend: 'Ext.form.Panel',
  alias: 'widget.documentgnercpanel',

  requires: [
    'Tel100.view.document.gnerc.PanelViewModel',
    'Tel100.view.document.gnerc.PanelViewController',
    'Ext.form.Panel',
    'Ext.grid.Panel',
    'Ext.grid.View',
    'Ext.grid.column.Action',
    'Ext.panel.Tool'
  ],

  controller: 'documentgnercpanel',
  viewModel: {
    type: 'documentgnercpanel'
  },
  border: false,
  defaultListenerScope: true,
  bodyPadding: 5,
  autoScroll: true,

  bind: {
    title: '{dynamicTitle}'
  },

  listeners: {
    beforerender: {
      fn: 'onBeforeRender',
      scope: 'controller'
    },
    smsselectioncomlete: {
      fn: 'onSmsSelectionComplete',
      scope: 'controller'
    }
  },

  items: [
  // {
  //   xtype: 'documentgnercsmscreatorpanel'
  // },
  // {
  //   xtype: 'documentgnercsmsviewerpanel'
  // },
  {
    xtype: 'displayfield',
    text: 'aaa',
    bind: {
      fieldLabel: '{i18n.document.base.gnerc_status}',
      value: '{send_status}'
    },
    renderer: function(value, object){
      return helpers.document.gnerc.formatGnercStatus(value);
    }
  }, 
  {
    xtype: 'displayfield',
    text: 'aaa',
    bind: {
      fieldLabel: '{i18n.document.base.my_status}',
      hidden: '{hideStatus}',
      value: '{status}'
    },
    renderer: function(value, object){
      if(value == "1"){
        return '<span class="label label-success"></i> ' + i18n.document.base.positive + '</span>';
      } else {
        return '<span class="label label-danger"></i> ' + i18n.document.base.negative + '</span>';
      }
    }
  }, 
  // {
  //             xtype: 'checkbox',
  //             inputValue: '1',
  //             uncheckedValue: '0',
  //             bind: {
  //               fieldLabel: '{i18n.document.base.positive}',
  //               disabled: '{!editable}',
  //               value: '{status}',
  //               hidden: '{!showSms}'
  //             },
  //             listeners: {
  //                 change: {
  //                   fn: 'onStatusChange'
  //                 }
  //             }
  //           },
  {
      xtype: 'segmentedbutton',
      width: '100%',
      margin: "0 0 5 0",
      // value: '1',
      // readOnly: 'true',
      bind: {
        // disabled: '{!editable}',
        hidden: '{!showAnswerStatus}',
        value: '{status}'
      },
      items: [
        {
          value: 1,
          bind: {
            text: '{i18n.document.base.positive}'
          },
        },
        {
          value: 0,
          bind: {
            text: '{i18n.document.base.negative}'
          }
        }
      ],
      listeners: {
        toggle: {
          fn: 'onStatusChange',
        }
      }
    },
    {
        xtype: 'combobox',
        anchor: '100%',
        editable: false,
        displayField: 'name',
        valueField: 'id',
        bind: {
          fieldLabel: '{i18n.document.base.gnerc_subtype}',
          value: '{type_id}',
          readOnly: '{notEditable}',
          store: '{gnerc_subtypes}',
          hidden: '{!isGnercType4}'
        },
        listConfig: {
         listeners: {
          select: {
            fn: 'onGnercTypeChange',
            scope: 'controller'
          },
          beforeshow: function(picker) {
             picker.minWidth = picker.up('combobox').getSize().width;
          }
         }
        }
      }, { 
            xtype: 'container',
            layout: {
              type: 'hbox',
              align: 'stretch'
            },
            anchor: '100%',
            items:[{
                xtype: 'textfield',
                flex: 5,
                readOnly: true,
                bind:{
                  fieldLabel: '{i18n.document.file.file}',
                  value: '{name}',
                }
              }, {
                xtype: 'filefield',
                name: 'file',
                buttonOnly: true,
                width: 29,
                buttonText: '<i class="fa fa-plus"></i>',
                bind: {
                  // fieldLabel: '{i18n.document.file.file}',
                  hidden: '{!showPlus}'
                },
                listeners: {
                  change: {
                    fn: 'onFilefieldChange',
                    scope: 'controller'
                  }
                }
              }, {
                xtype: 'button',
                margin: 1,
                width: 29,
                text: '<i class="fa fa-minus"></i>',
                bind: {
                  hidden: '{!showMinus}',
                },
                listeners: {
                  click: {
                    fn: 'onFileRemoveClick',
                    scope: 'controller'
                  }
                }
              }]
         }, {
            xtype: 'container',
            anchor: '100%',
            layout: {
              type: 'vbox',
              pack: 'top',
            },
            items: [{
              xtype: 'checkbox',
              inputValue: '1',
              uncheckedValue: '0',
              bind: {
                fieldLabel: '{i18n.document.base.mediate}',
                readOnly: '{!smsEditable}',
                value: '{mediate}',
                hidden: '{hideMediate}'
              },
              listeners: {
                  change: {
                    fn: 'onMediateClick',
                    scope: 'controller'
                  }
              }
            }]
         }, { 
            xtype: 'gridpanel',
            name: 'smses',
            anchor: '100%',
            hideHeaders: true,
            bind: {
              store: '{smses}'
            },
            columns: [{
              xtype: 'gridcolumn',
              renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                var text = record.get('text');
                if (text) {
                  text = '<p class="text-muted" style="white-space:normal;margin:0;">' + text + '</p>'
                };

                return [
                  '<p style="margin:0;"><i class="fa fa-phone">&nbsp;</i><span class="text-danger">', record.get('phone'), '</span></p>',
                  text
                ].join('');

              },
              flex: 1,
              sortable: false,
              hidable: false
            }, {
                  xtype: 'checkcolumn',
                  width: 25,
                  dataIndex: 'active',
                  bind: {
                    hidden: '{!smsEditable}'
                  },
                  listeners: {
                    checkchange: function(view, rowIndex, checked, eOpts){
                      var panel = view.up('documentgnercpanel');
                      var id = panel.getViewModel().getStore('smses').getAt(rowIndex).id;
                      var value = checked === true ? 1 : 0;
                      helpers.api.document.gnerc.updateSms(id, { params: { active: value }});
                    }
                  }
            },{
                  xtype: 'actioncolumn',
                  width: 23,
                  bind: {
                    hidden: '{!smsEditable}'
                  },
                  items: [{
                    icon: '/images/pencil.png',
                    handler: function(grid, rowIndex, colIndex) {
                      var item = grid.getStore().getAt(rowIndex);
                      var me = this.getView();
                      Ext.Msg.prompt({
                          title: 'SMS',
                          row: rowIndex,
                          message: 'Edit sms:',
                          width: 300,
                          buttons: Ext.Msg.OKCANCEL,
                          multiline: true,
                          fn: function(buttonValue, inputText, showConfig) {
                            var store = this.getStore();
                            var item = store.getAt(showConfig.row);
                            item.set('text', inputText);

                            var id = item.id;
                            helpers.api.document.gnerc.updateSms(id, { params: { text: inputText }});
                          },
                          scope: me,
                          value: item.get('text')
                      });
                    }
                  }]
            },{
                  xtype: 'actioncolumn',
                  width: 23,
                  bind: {
                    hidden: '{!smsEditable}'
                  },
                  items: [{
                    icon: '/images/drawer.png',
                    handler: function(grid, rowIndex, colIndex){
                      var smsid = grid.getStore().getAt(rowIndex).id;
                      var me = this;

                      var smsselector = Ext.create('Tel100.view.document.gnerc.SmsSelector', function(data){
                      });

                      smsselector.getViewModel().set('id', smsid);
                      smsselector.on('smsselectioncomplete', function(data){
                        helpers.api.document.gnerc.updateSms(smsid, { params: { text: data },
                          success: function(){
                            this.up('documentgnercpanel').refresh();                         
                          }.bind(grid)
                        });
                        
                      });
                      smsselector.show();
                    }
                  }]
            }]
          }, {
            xtype: 'button',
            width: '100%',
            bind: {
              text: '<i class="fa fa-plus">&nbsp;SMS</i>',
              hidden: '{!showSendSms}'
            },
            handler: function(button, e){
                  var gnercpanel = this.up('documentgnercpanel');
                  var vm = gnercpanel.getViewModel();
                  Ext.Msg.prompt({
                      title: 'SMS',
                      message: 'Add sms:',
                      width: 300,
                      buttons: Ext.Msg.OKCANCEL,
                      multiline: true,
                      fn: function(buttonValue, inputText, showConfig) {
                        if(buttonValue === 'ok'){
                          helpers.api.document.gnerc.sendSms(vm.get('document').id, { params: { text: inputText }});
                        }
                      },
                      scope: gnercpanel,
                      value: ''
                });
            }
          }, {
            xtype: 'button',
            width: '100%',
            bind: {
              text: '{i18n.document.base.gnerc_send}',
              hidden: '{hideSend}'
            },
            handler: function(button, e){
              var gnercpanel = this.up('documentgnercpanel');
              var vm = gnercpanel.getViewModel();
              var mask = new Ext.LoadMask({ msg: "Sending to GNERC", target: gnercpanel });
              // mask.show();
              helpers.api.document.gnerc.send(vm.get('document').id, { params: { },
                view: gnercpanel, 
                success: function(){
                    this.up('documentgnercpanel').refresh();
                    // mask.hide();
                }.bind(button)
                // ,
                // failure: function() {
                //   mask.hide();
                // }
              });
            }
          },
          {
            xtype: 'box',
            autoEl: {tag: 'hr'}
          },
          {
            xtype: 'button',
            width: '100%',
            bind: {
              text: '{i18n.document.base.chose_abonent}',
              hidden: '{hideAddCustomer}'
            },
            handler: function(button, e) {
              var view = this.up('documentgnercpanel');
              var dialog = helpers.party.getPartyDialog(function(assignees) {
                view.getController().addCustomer(assignees);
              });
              dialog.show();
            },
          },
          {
            xtype: 'container',
            defaults: {
                margin: '0 0 0 0',
                padding: '0 0 0 0',
            },
            items: [{
              xtype: 'displayfield',
              text: 'aaa',
              bind: {
                fieldLabel: '{i18n.document.base.accnumb}',
                value: '{customer.customer_accnumb}'
              },
              renderer: function(value, object){  return '<strong>' + value + '</strong>'; }
            }, {
              xtype: 'displayfield',
              text: 'aaa',
              bind: {
                fieldLabel: '{i18n.document.base.fullname}',
                value: '{customer.customer_name}'
              },
              renderer: function(value, object){  return '<strong>' + value + '</strong>'; }
            }, {
              xtype: 'displayfield',
              text: 'aaa',
              bind: {
                fieldLabel: '{i18n.document.base.gnerc_phone}',
                value: '{customer.customer_phone}'
              },
              renderer: function(value, object){  
                var customer = object.up('panel').getViewModel().get('customer');

                if (customer && customer.correct_mobile){
                  return '<i class="text-success fa fa-check"></i> <strong>' + value + '</strong>'; 
                } else {
                  return '<i data-qtip="SMS არ გაიგზავნება" class="text-danger fa fa-exclamation-triangle"></i> <strong>' + value + '</strong>'; 
                }
              }
            }, {
              xtype: 'displayfield',
              text: 'aaa',
              bind: {
                fieldLabel: '{i18n.document.base.gnerc_mail}',
                value: '{customer.customer_email}'
              },
              renderer: function(value, object){  return '<strong>' + value + '</strong>'; }
            }, {
              xtype: 'displayfield',
              text: 'aaa',
              bind: {
                fieldLabel: '{i18n.document.base.gnerc_taxid}',
                value: '{customer.customer_taxid}'
              },
              renderer: function(value, object){  return '<strong>' + value + '</strong>'; }
            }]
          },{
            xtype: 'box',
            autoEl: {tag: 'hr'}
          },
          {
            xtype: 'container',
            defaults: {
                margin: '2 2 2 2',
                padding: '0 0 0 0',
            },
            layout: {
              type: 'table',
              columns: 3,
              tableAttrs: {
                style: {
                    width: '100%',
                    padding: '10px;'
                }
              }
            },
            bind: {
              hidden: '{hideAddCustomer}'
            },
            items :[{
              xtype: 'displayfield',
              bind: {
                value: '{i18n.document.base.exchange_info}',
              },
              colspan: 3
            },{
              xtype: 'displayfield',
              value: 'GWP'
            },{
              xtype: 'checkboxfield',
              bind: {
                value: '{customer.agree_water}'
              },
              listeners: {
                  change: function(view, value){
                    this.up('documentgnercpanel').getController().onInfoClick('agree_water', value);
                  }
              }
            }, {
              xtype: 'textfield',
              width: '100%',
              bind: {
                value: '{customer.water_customer}'
              },
              listeners: {
                  change: function(view, value){
                    this.up('documentgnercpanel').getController().onInfoClick('water_customer', value);
                  },
                  buffer: 500
              }
            },
            {
              xtype: 'displayfield',
              value: 'გაზი'
            },{
              xtype: 'checkboxfield',
              bind: {
                value: '{customer.agree_gas}'
              },
              listeners: {
                  change: function(view, value){
                    this.up('documentgnercpanel').getController().onInfoClick('agree_gas', value);
                  }
              }
            },{
              xtype: 'textfield',
              width: '100%',
              bind: {
                value: '{customer.gas_customer}'
              },
              listeners: {
                  change: function(view, value){
                    this.up('documentgnercpanel').getController().onInfoClick('gas_customer', value);
                  },
                  buffer: 500
              }
            },{},{},{
              xtype: 'combobox',
              width: '100%',
              displayField: 'name',
              valueField: 'id',
              editable: false,
              tpl: Ext.create('Ext.XTemplate',
                  '<tpl for=".">',
                      '<div data-qtip="{description}" class="x-boundlist-item"><code>{id}</code> - {name}</div>',
                  '</tpl>'
              ),
              displayTpl: Ext.create('Ext.XTemplate',
                  '<tpl for=".">',
                      '{id} - {name}',
                  '</tpl>'
              ),
              bind: {
                value: '{customer.gas_provider}',
                store: '{gas_providers}'
              },
              listeners: {
                  change: function(view, value){
                    this.up('documentgnercpanel').getController().onInfoClick('gas_provider', value);
                  },
                  buffer: 500
              }
            },
            ]
          }
    ],
  tools: [
    {
      xtype: 'tool',
      type: 'refresh',
      listeners: {
        click: 'onRefresh'
      }
    }
  ],

  onRefresh: function(tool, e, owner, eOpts) {
    this.refresh();
  },

  onResetSmsClick: function(){
    this.getController().resetSms();
  },

  // onStatusChange: function(view, newValue, oldValue, eOpts){
  //   debugger;
  //   var vm = this.getViewModel();
  //   var value = newValue == false ? 0 : 1;
  //   this.getController().onGnercStatusChange(value);
  //   helpers.api.document.gnerc.resetSms(vm.get('document').id, value,{
  //     success: function(){
  //         vm.getStore('smses').load();
  //     }
  //   });
  // },  

  onStatusChange: function(view, button, isPressed, eOpts){
    var vm = this.getViewModel();
    this.getController().onGnercStatusChange(vm.get('status'));
    helpers.api.document.gnerc.resetSms(vm.get('document').id, vm.get('status'),{
      success: function(){
          vm.getStore('smses').load();
      }
    });
  },

  refresh: function() {
    var vm = this.getViewModel();
    vm.getStore('gnerc').load();
    // vm.getStore('smshistory').load();
    vm.getStore('smses').load();
  },

  initComponent: function() {
    this.callParent();
    var view = this;
    var viewModel = this.getViewModel();
    viewModel.bind('{gnerc}', function(store) {
      if (store) {
        store.view = view;
        store.viewModel = viewModel;
      }
    });
  },

  setEditable: function(editable) {
    var vm = this.getViewModel();
    vm.set('editable', editable);
  },

  getEditable: function() {
    var vm = this.getViewModel();
    return vm.get('editable');
  }

});