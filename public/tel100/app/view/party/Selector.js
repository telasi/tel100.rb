/*
 * File: app/view/party/Selector.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Tel100.view.party.Selector', {
  extend: 'Ext.window.Window',
  alias: 'widget.partyselector',

  requires: [
    'Tel100.view.party.SelectorViewModel',
    'Tel100.view.party.SelectorViewController',
    'Tel100.view.hr.tree.Panel',
    'Tel100.view.hr.party.Grid',
    'Tel100.view.bs.customer.Panel',
    'Ext.tab.Panel',
    'Ext.tree.Panel',
    'Ext.tab.Tab',
    'Ext.grid.Panel',
    'Ext.toolbar.Toolbar',
    'Ext.toolbar.Spacer',
    'Ext.resizer.Splitter',
    'Ext.grid.View',
    'Ext.grid.column.Column',
    'Ext.panel.Tool'
  ],

  controller: 'partyselector',
  viewModel: {
    type: 'partyselector'
  },
  height: 600,
  width: 950,
  autoDestroy: false,
  closeAction: 'hide',
  title: 'Select Party',
  maximizable: true,
  modal: true,
  defaultListenerScope: true,

  layout: {
    type: 'hbox',
    align: 'stretch'
  },
  items: [
    {
      xtype: 'tabpanel',
      flex: 1,
      activeTab: 0,
      items: [
        {
          xtype: 'hrtreepanel',
          tools: [
            {
              type: 'plus',
              handler: function() {
                var tree = this.up('hrtreepanel');
                var selection = tree.getSelection();
                if (selection.length > 0) {
                  var controller = this.up('partyselector').getController();
                  controller.onAddParty(selection[0]);
                }
              }
            }
          ],
          cls: 'panel-with-border',
          listeners: {
            celldblclick: 'onHRTreeDblClick'
          }
        },
        {
          xtype: 'hrpartygrid',
          listeners: {
            itemdblclick: 'onPartyGridpanelItemDblClick'
          }
        },
        {
          xtype: 'bscustomerpanel',
          listeners: {
            itemdblclick: 'onCustomerGridpanelItemDblClick'
          }
        }
      ]
    },
    {
      xtype: 'splitter',
      width: 5
    },
    {
      xtype: 'gridpanel',
      cls: 'panel-with-border',
      itemId: 'selectedParties',
      width: 300,
      bodyBorder: true,
      hideHeaders: true,
      bind: {
        title: '{i18n.selector.selectedParties}',
        store: '{parties}'
      },
      columns: [
        {
          xtype: 'gridcolumn',
          renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
            switch(record.get('ext_type')){
              case 'hr.Employee':
              if(record.toTreeHtml){
                return record.toTreeHtml();
              }
              break;
              case 'hr.Party':
              return record.get('name_ka');
              case 'hr.Customer':
              return record.get('name');
            }
          },
          dataIndex: 'name',
          text: 'Name',
          flex: 1
        }
      ],
      listeners: {
        celldblclick: 'onSelectedPartiesCellDblClick'
      },
      tools: [
        {
          xtype: 'tool',
          type: 'minus',
          listeners: {
            click: 'onRemoveToolClick'
          }
        }
      ]
    }
  ],
  dockedItems: [
    {
      xtype: 'toolbar',
      flex: 1,
      dock: 'bottom',
      items: [
        {
          xtype: 'button',
          bind: {
            text: '{i18n.ui.cancel}'
          },
          listeners: {
            click: 'onCancelClick'
          }
        },
        {
          xtype: 'tbspacer',
          flex: 1
        },
        {
          xtype: 'button',
          bind: {
            text: '{i18n.selector.selectorConfirm}'
          },
          listeners: {
            click: 'onSelectClicked'
          }
        }
      ]
    }
  ],

  onHRTreeDblClick: function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
    if (record.get('ext_type') === 'hr.Employee' && record.get('has_user')) {
      this.getController().onAddParty(record);
    }
  },

  onPartyGridpanelItemDblClick: function(dataview, record, item, index, e, eOpts) {
       if (record.get('ext_type') === 'hr.Party') {
              this.getController().onAddParty(record);
       }
  },

  onCustomerGridpanelItemDblClick: function(dataview, record, item, index, e, eOpts) {
    if (record.get('ext_type') === 'hr.Customer') {
          this.getController().onAddParty(record);
    }
  },

  onCancelClick: function(button, e, eOpts) {
    this.close();
  },

  onSelectClicked: function(button, e, eOpts) {
    var data = [];
    var grid = this.down('gridpanel');
    var store = grid.getStore();
    store.each(function(item) { data.push(item); });
    this.fireEvent('selectioncomplete', data);
    store.removeAll();
    this.close();
  },

  onSelectedPartiesCellDblClick: function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
    this.getController().onRemoveParty(record);
  },

  onRemoveToolClick: function(tool, e, owner, eOpts) {
    var grid = this.down('gridpanel');
    var selection = grid.getSelection();
    if (selection.length > 0) {
      this.getController().onRemoveParty(selection[0]);
    }
  }

});